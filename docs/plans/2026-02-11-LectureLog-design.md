# LectureLog — Дизайн-документ

## Обзор

Open-source платформа для автоматического конспектирования лекций. Пользователь записывает аудио на лекции, загружает вместе с фотографиями досок и слайдами — система транскрибирует, структурирует и выдаёт готовый конспект с разделами, аудио-фрагментами и привязанными медиа.

**Ключевые принципы:**
- Self-hosted: `docker compose up` и работает
- Провайдер-агностик: пользователь выбирает STT и LLM провайдера (Groq, OpenAI, Ollama и т.д.)
- Нет vendor lock-in: экспорт в Markdown + медиа
- Open-source

---

## Архитектура

Микросервисная архитектура на **Go**, фронтенд на **Nuxt 3 (Vue 3)**.

### Сервисы

| Сервис | Ответственность |
|--------|----------------|
| **API Gateway** | Маршрутизация, JWT-авторизация, rate limiting, CORS |
| **Auth Service** | Регистрация, логин, управление пользователями и ролями |
| **Upload Service** | Приём и валидация аудио, фото, слайдов. Сохранение в S3 |
| **Processing Service** | Пайплайн обработки: препроцессинг → транскрибация → LLM → нарезка → QA |
| **Content Service** | CRUD конспектов, предметов, разделов, оценок. Полнотекстовый поиск |

### Инфраструктура

| Компонент | Назначение |
|-----------|-----------|
| **PostgreSQL** | Основное хранилище (пользователи, конспекты, метаданные, оценки) |
| **NATS** | Очередь задач для асинхронных операций |
| **MinIO** | S3-совместимое хранилище файлов (аудио, фото, слайды) |

### Коммуникация

- REST между фронтендом и API Gateway
- REST между Gateway и сервисами
- NATS для асинхронных задач (транскрибация, обработка LLM)

---

## Пайплайн обработки

### Этапы

```
Загрузка → Валидация → Препроцессинг аудио → [Параллельно: Транскрибация + OCR + EXIF] → Структурирование (LLM) → QA-оценка → [Петля если не прошло] → Нарезка аудио → Сохранение
```

### 1. Загрузка и валидация
- Приём аудио (mp3/wav/ogg/m4a), фото (jpg/png), слайдов (pdf/pptx)
- Проверка форматов, размеров
- Пользователь указывает: предмет, дата лекции, время начала записи

### 2. Препроцессинг аудио (ffmpeg)

Модуль препроцессинга реализуется как **самостоятельная Go-библиотека** (`audiopreproc`), независимая от LectureLog. Может использоваться как CLI-инструмент или как библиотека в других проектах.

#### Этапы обработки (выполняются последовательно)

1. **Нарезка на чанки** — `ffmpeg` режет входной файл на сегменты до 60 секунд в формате WAV 44.1kHz mono (`pcm_s16le`)
2. **Вырезание длинной тишины** — из каждого чанка удаляются паузы через `silencedetect`/`atrim` (дефолт: `-35dB`, `5s`)
3. **Шумоподавление чанков** — Python-скрипт `scripts/denoise.py` отправляет каждый очищенный чанк в HuggingFace Space `ResembleAI/resemble-enhance` через `gradio_client`
4. **Склейка результата** — `ffmpeg` собирает обработанные чанки обратно в один выходной файл

Публичный API модуля: одна функция `Process(ctx, input, output string) error`.

#### Ограничения и зависимости

- Нужен `ffmpeg` в системе
- Нужен `python3` и установленный пакет `gradio_client`
- Для обработки требуется сетевой доступ к HF Space API
- Предел одного чанка — до 60 секунд (ограничение Space)

#### Архитектура библиотеки

```
audiopreproc/
├── audiopreproc.go      # Process(ctx, input, output) + проверки python/gradio_client
├── ffmpeg.go            # CheckFFmpeg, splitChunks, concatChunks, getAudioDuration
├── silence.go           # detectSilence/removeSilenceFromChunks
├── scripts/
│   └── denoise.py       # Вызов Resemble Enhance HF Space API
└── testdata/            # Тестовые аудиофайлы
```

#### Вызов из Go

```go
err := audiopreproc.Process(ctx, "input.m4a", "output.mp3")
```

### 3. Параллельная обработка
- **Транскрибация** — отправка в STT-провайдер чанками по 20-30 мин с перекрытием, текст с таймкодами + confidence scores. Диаризация если поддерживается
- **OCR изображений** — распознавание текста с фото досок и слайдов, подаётся LLM как дополнительный контекст
- **Извлечение EXIF** — временные метки фото, вычисление таймкода: время фото - время начала записи = позиция в лекции

### 4. Структурирование (LLM)
- На входе: транскрипт + OCR-текст + метаданные фото
- На выходе: разбивка на разделы с заголовками, обработанный текст, привязка фото к разделам
- Привязка фото: по EXIF-таймкоду для фотографий, по смысловому сопоставлению LLM для слайдов
- Детекция языка — автоподстройка промпта

### 5. QA-оценка (независимая LLM)
- Оценка: полнота, структурированность, связность (0-100)
- **Петля исправления:** если оценка ниже порога — отправляем результат + замечания QA обратно в структурирующую LLM для точечного исправления (не с нуля). LLM видит свой предыдущий результат и конкретные замечания, правит только проблемные места
- Максимум 3 попытки. Если после 3-й попытки порог не пройден — публикуем с пометкой "низкое качество, требует ручной доработки"
- Если оценка ОК — переход к нарезке
- Пометка "битых" фрагментов с низким confidence score как "требует ручной проверки"

### 6. Нарезка аудио
- По таймкодам разделов нарезка через ffmpeg
- Каждый раздел получает свой аудио-фрагмент

### 7. Сохранение
- Запись метаданных в PostgreSQL
- Загрузка медиа в MinIO (S3)
- Публикация конспекта

### Отслеживание прогресса
- Каждый этап отчитывается о прогрессе
- Пользователь видит статус в реальном времени: "Транскрибация... 60%"

---

## Стоимость обработки одной лекции

Расчёт для типичной лекции — 1.5 часа аудио:

| Этап | Бесплатные API (Groq) | Платные API (OpenAI) |
|------|----------------------|---------------------|
| Транскрибация | $0 (бесплатный tier ~28 ч/день) | ~$0.54 ($0.006/мин) |
| Структурирование (LLM) | $0 (бесплатный tier) | ~$0.01-0.05 |
| QA-оценка | $0 | ~$0.01-0.03 |
| QA-петля (worst case x3) | $0 | до ~$0.15 |
| OCR | $0 | копейки |
| **Итого** | **$0 - $0.05** | **$0.10 - $0.50** |

---

## Контроль качества: борьба с нейрослопом

Ключевой принцип: **LLM — это форматировщик, а не автор.** Она структурирует и оформляет чужой текст, а не пишет свой.

### Уровень 1: Промпт-инженерия

Правила для промпта структурирования:
- **"Не добавляй информацию, которой нет в транскрипте"** — запрет на отсебятину
- **"Сохраняй точные формулировки, термины и определения"** — если преподаватель сказал "гомоморфизм колец", не заменять на "преобразование математических структур"
- **"Не используй вводные фразы: 'Давайте рассмотрим', 'Важно отметить', 'Следует подчеркнуть'"** — прямой запрет на типичный слоп
- **"Если мысль обрывается или неясна — помечай [неясный фрагмент], а не додумывай"**
- **Few-shot примеры** — в промпте 2-3 примера: "вот транскрипт → вот правильный результат". Сильнее любых инструкций

### Уровень 2: QA-промпт

QA-LLM проверяет конкретно на слоп:
- **Фактчек** — сверяет каждое утверждение конспекта с транскриптом
- **Детекция "воды"** — ищет пустые фразы и общие места, которых не было в оригинале
- **Потеря информации** — есть ли в транскрипте важные мысли, не попавшие в конспект
- **Конкретная оценка** — не "хорошо/плохо", а: "в разделе 3 добавлено предложение X, которого нет в транскрипте", "в разделе 5 потеряно определение Y"

### Уровень 3: Версионируемые промпты

- Промпты хранятся в репозитории как отдельные файлы, не захардкожены
- A/B тестирование: новый промпт → сравнение качества
- Контрибьюторы open-source проекта могут улучшать промпты

### Уровень 4: Пользовательский контроль

- Кнопка "Показать оригинальный транскрипт" рядом с каждым разделом — пользователь сравнивает что было сказано и что написала LLM
- Видимая метка на разделах с низким confidence score
- Звёзды и отзывы — краудсорсинг качества

---

## Модель данных

### User
- id, email, password_hash, role (reader/uploader/admin), created_at

### Subject (Предмет)
- id, name, description, created_by, created_at

### Lecture (Лекция/Конспект)
- id, subject_id, title, date, recording_start_time, status (processing/review/published/failed), raw_transcript, created_by, created_at

### Section (Раздел конспекта)
- id, lecture_id, order, title, content (обработанный текст), audio_fragment_url, timecode_start, timecode_end

### Media (Медиафайлы)
- id, lecture_id, section_id (nullable), type (photo/slide/audio_original/audio_fragment), url, exif_time, ocr_text

### QualityScore (Оценка качества)
- id, lecture_id, llm_score (0-100), llm_summary, completeness, structure, coherence, attempt_number

### UserReview (Пользовательская оценка)
- id, lecture_id, user_id, stars (1-5), comment, created_at

### SectionVersion (История изменений разделов)
- id, section_id, content, edited_by, created_at

### Tag
- id, name

### LectureTag
- lecture_id, tag_id

### Полнотекстовый поиск
- PostgreSQL FTS (pg_tsvector) по: section.content, section.title, lecture.title, tag.name

---

## API

### Auth Service
- `POST /auth/register` — регистрация
- `POST /auth/login` — логин, возвращает JWT
- `POST /auth/refresh` — обновление токена
- `GET /users/me` — профиль
- `PUT /users/me` — обновление профиля
- `GET /users` — список пользователей (admin)
- `PUT /users/:id/role` — изменение роли (admin)

### Upload Service
- `POST /upload` — загрузка аудио + фото + слайдов, время начала записи, дата, предмет

### Content Service
- `GET/POST /subjects` — предметы
- `GET/POST /lectures` — лекции, фильтрация по предмету, дате, тегам
- `GET /lectures/:id` — конспект
- `GET /lectures/:id/sections` — разделы
- `PUT /lectures/:id/sections/:id` — редактирование раздела (автор + admin, версионируется)
- `GET /search?q=` — полнотекстовый поиск
- `POST /lectures/:id/reviews` — пользовательская оценка
- `GET /lectures/:id/export` — экспорт Markdown + медиа (zip)

### Processing Service (внутренний)
- `POST /process` — запуск пайплайна
- `GET /process/:id/status` — статус + прогресс

---

## Авторизация и роли

Три роли с наследованием прав:

| Действие | Читатель | Загрузчик | Админ |
|----------|----------|-----------|-------|
| Просмотр конспектов | + | + | + |
| Оценка (звёзды, отзывы) | + | + | + |
| Поиск | + | + | + |
| Загрузка материалов | - | + | + |
| Редактирование своих конспектов | - | + | + |
| Редактирование любых конспектов | - | - | + |
| Управление пользователями | - | - | + |
| Управление ролями | - | - | + |
| Модерация конспектов | - | - | + |

---

## Фронтенд (Nuxt 3)

### Страницы

- **Главная** — каталог предметов, поисковая строка
- **Предмет** — список лекций по датам, описание предмета
- **Лекция** — основная страница конспекта:
  - Навигация по разделам (sidebar)
  - Для каждого раздела: заголовок, текст, аудио-плеер, фото/слайды
  - Inline-редактирование (автор/admin)
  - Кнопка "Экспорт" (zip)
  - Оценки: LLM-оценка + средняя пользовательская + форма отзыва
  - Кнопка "Скопировать ссылку" на каждом разделе
- **Загрузка** — форма: предмет, дата, время начала записи, файлы. Прогресс-бар обработки
- **Админка** — управление пользователями, ролями, модерация
- **Профиль** — настройки, мои загрузки, мои оценки

### URL-схема
- `/lectures/:id` — ссылка на конспект
- `/lectures/:id#section-:order` — ссылка на конкретный раздел

---

## Экспорт

Кнопка "Экспорт" генерирует zip-архив:

```
lecture-2026-02-11-matematika/
├── konspekt.md
├── audio/
│   ├── section-1-vvedenie.mp3
│   ├── section-2-integraly.mp3
│   └── ...
└── images/
    ├── board-1.jpg
    ├── slide-3.png
    └── ...
```

Markdown-файл содержит ссылки на локальные медиа. Открывается в Obsidian, Notion, любом md-редакторе.

---

## Деплой (Docker Compose)

```yaml
services:
  gateway:      # API Gateway (Go)
  auth:         # Auth Service (Go)
  content:      # Content Service (Go)
  processing:   # Processing Service (Go)
  upload:       # Upload Service (Go)
  frontend:     # Nuxt 3 (Node)
  postgres:     # PostgreSQL
  nats:         # Очередь задач
  minio:        # S3-совместимое хранилище
```

### Конфигурация (.env)
```env
# Транскрибация
STT_PROVIDER=groq
STT_API_KEY=...

# LLM для структурирования
LLM_PROVIDER=groq
LLM_API_KEY=...

# LLM для QA-оценки (рекомендуется другой провайдер)
QA_LLM_PROVIDER=openai
QA_LLM_API_KEY=...

# Инфраструктура
JWT_SECRET=...
POSTGRES_PASSWORD=...
MINIO_ACCESS_KEY=...
MINIO_SECRET_KEY=...
```

### Self-hosting
```bash
git clone <repo>
cp .env.example .env
# заполнить API ключи
docker compose up -d
```

---

## Приоритеты реализации

### MVP (первый релиз)
- Auth Service (регистрация, логин, 3 роли)
- Upload Service (приём аудио + фото + слайдов)
- Пайплайн: препроцессинг аудио (нормализация, шумоподавление, вырезание тишины) → транскрибация → структурирование LLM → нарезка аудио по разделам
- Content Service (CRUD лекций, разделов, предметов)
- Фронтенд: каталог → предмет → конспект с аудио-плеером и фото
- Экспорт в Markdown + zip
- Docker Compose деплой

### Второй этап
- OCR с фото досок и слайдов
- Привязка фото к разделам (EXIF + LLM-сопоставление для слайдов)
- QA-оценка с петлёй переделки
- Пользовательские оценки (звёзды, отзывы)
- Редактирование разделов (автор + админ, версионирование)
- Полнотекстовый поиск (PostgreSQL FTS)

### Третий этап
- Диаризация (преподаватель vs студент)
- Детекция языка и мультиязычные промпты
- Детекция "битых" фрагментов с низким confidence
- Chunked processing для длинных лекций (1.5+ часа)
- Ссылки на конкретные разделы + кнопка "Скопировать ссылку"

---

## Технический стек

| Компонент | Технология |
|-----------|-----------|
| Бэкенд | Go |
| Фронтенд | Nuxt 3 (Vue 3) |
| БД | PostgreSQL |
| Очередь | NATS |
| Файловое хранилище | MinIO (S3-совместимое) |
| Аудио-обработка | FFmpeg |
| Транскрибация | Провайдер-агностик (Groq, OpenAI, ...) |
| LLM | Провайдер-агностик (Groq, OpenAI, Ollama, ...) |
| Контейнеризация | Docker Compose |
